name: ğŸš€ Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        default: ''

env:
  AWS_REGION:     us-east-1
  ECR_REGISTRY:   ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: weather-ml-api
  EKS_CLUSTER:    weather-ml-staging
  NAMESPACE:      weather-ml

jobs:
  # â”€â”€â”€ 1. Code Quality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dev dependencies
        run: pip install ruff black mypy bandit safety

      - name: Lint with Ruff
        run: ruff check app/ model/

      - name: Format check with Black
        run: black --check app/ model/

      - name: Type check with MyPy
        run: mypy app/ --ignore-missing-imports

      - name: Security scan with Bandit
        run: bandit -r app/ -f json -o bandit-report.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-report-staging
          path: bandit-report.json

      - name: Dependency vulnerability scan
        run: safety check -r requirements.txt

  # â”€â”€â”€ 2. Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB:       weatherdb_test
          POSTGRES_USER:     weather
          POSTGRES_PASSWORD: weather123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt pytest pytest-asyncio pytest-cov httpx

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v \
            --cov=app             \
            --cov-report=xml      \
            --cov-report=term-missing

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://weather:weather123@localhost:5432/weatherdb_test
          REDIS_URL:    redis://localhost:6379/0
        run: |
          pytest tests/test_api.py -v --timeout=60

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          file:  coverage.xml
          flags: staging

  # â”€â”€â”€ 3. Model Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  model-validation:
    name: ğŸ¤– Model Validation
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install ML dependencies
        run: pip install -r requirements.txt

      - name: Validate model performance
        run: |
          python scripts/validate_model.py \
            --min-r2=0.83                  \
            --max-rmse=3.5                 \
            --model-path=./model           \
            --summary

      - name: Upload validation report
        uses: actions/upload-artifact@v3
        with:
          name: model-validation-staging
          path: validation_report.json

      - name: Check for data drift
        run: |
          python scripts/check_data_drift.py \
            --reference-data=data/reference_dataset.csv \
            --threshold=0.15

  # â”€â”€â”€ 4. Build & Push Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ³ Build & Push Image
    runs-on: ubuntu-latest
    needs: [test, model-validation]
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=sha,prefix=sha-
            type=ref,event=branch
            type=raw,value=staging-latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context:    .
          push:       true
          tags:       ${{ steps.meta.outputs.tags }}
          labels:     ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to:   type=gha,mode=max
          platforms:  linux/amd64,linux/arm64

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          format:    sarif
          output:    trivy-results.sarif
          severity:  CRITICAL,HIGH

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-results.sarif

  # â”€â”€â”€ 5. Deploy to Staging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
      url:  https://weather-api-staging.example.com
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER }} \
            --region ${{ env.AWS_REGION }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install weather-api ./helm/weather-api \
            --namespace ${{ env.NAMESPACE }}                    \
            --create-namespace                                  \
            --set image.tag=${{ needs.build.outputs.image-tag }} \
            --set environment=staging                           \
            --set replicaCount=2                                \
            --values helm/weather-api/values-staging.yaml      \
            --wait --timeout=5m

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/weather-api \
            -n ${{ env.NAMESPACE }} --timeout=120s
